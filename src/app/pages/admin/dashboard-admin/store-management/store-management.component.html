<div class="user-management-container">

  <div class="header-section">
    <h1>Quản lý cửa hàng</h1>
    <p>Theo dõi và quản lý tất cả các cửa hàng trong hệ thống</p>
  </div>

  <div class="search-criteria-card">
    <div class="card-header">
      <i class="fas fa-filter icon-filter"></i>
      <h3>Điều kiện tìm kiếm</h3>
    </div>
    <p class="search-description">Điền thông tin để lọc kết quả tìm kiếm chính xác hơn</p>

    <div class="search-form">
      <div class="form-group">
        <label for="storeName">Tên cửa hàng</label>
        <input type="text" id="storeName" [(ngModel)]="filter.storeName" placeholder="Nhập tên cửa hàng">
      </div>

      <div class="form-group">
        <label for="address">Địa chỉ</label>
        <input type="text" id="address" [(ngModel)]="filter.address" placeholder="Nhập địa chỉ">
      </div>

      <button class="search-button" (click)="performSearch()">
        <i class="fas fa-search"></i>
        Tìm kiếm
      </button>
    </div>
  </div>

  <div class="search-results-summary">
    <h2>Kết quả tìm kiếm</h2>
    <div class="total-rows">
      <span>Tổng số dòng:</span>
      <strong>{{ totalElementsCount }}</strong>
    </div>
    <p class="link-text">Danh sách cửa hàng</p>
  </div>

  <div class="creative-table-card">
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>STT</th>
            <th>Logo</th>
            <th>Tên cửa hàng</th>
            <th>Địa chỉ</th>
            <th>Số điện thoại</th>
            <th>Email</th>
            <th>Xe đã bán</th>
            <th>Xe còn lại</th>
            <th>Tổng xe</th>
            <th>Lịch hẹn</th>
            <th>Lượt yêu thích</th>
            <th>Ngày tạo</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let store of stores; let i = index">
            <td>{{ i + 1 + currentPage * pageSize }}</td>
            <td>
              <img [src]="store.logoUrl || '/assets/default-store-logo.png'" 
                   alt="Logo" 
                   class="store-logo"
                   onerror="this.src='/assets/default-store-logo.png'">
            </td>
            <td>{{ store.storeName }}</td>
            <td>{{ store.address }}</td>
            <td>{{ store.phone }}</td>
            <td>{{ store.email || 'N/A' }}</td>
            <td><span class="badge badge-success">{{ formatNumber(store.carSold) }}</span></td>
            <td><span class="badge badge-info">{{ formatNumber(store.carAvailable) }}</span></td>
            <td><span class="badge badge-primary">{{ formatNumber(store.totalCars) }}</span></td>
            <td>
              <div class="appointment-stats">
                <span class="stat-item" title="Tổng">
                  <i class="fas fa-calendar-alt"></i> {{ formatNumber(store.totalAppointments) }}
                </span>
                <span class="stat-item pending" title="Chờ xác nhận">
                  <i class="fas fa-clock"></i> {{ formatNumber(store.pendingAppointments) }}
                </span>
                <span class="stat-item confirmed" title="Đã xác nhận">
                  <i class="fas fa-check"></i> {{ formatNumber(store.confirmedAppointments) }}
                </span>
                <span class="stat-item completed" title="Hoàn thành">
                  <i class="fas fa-check-double"></i> {{ formatNumber(store.completedAppointments) }}
                </span>
              </div>
            </td>
            <td>
              <span class="favorite-count">
                <i class="fas fa-heart"></i> {{ formatNumber(store.totalFavorites) }}
              </span>
            </td>
            <td>{{ formatDate(store.createdDate) }}</td>
            <td class="action-buttons">
              <div class="form-row">
                <div class="form-group half">
                  <button class="btn-edit" (click)="openEditModal(store)" title="Sửa">
                    <i class="fas fa-pen"></i>
                  </button>
                </div>
                <div class="form-group half">
                  <button class="btn-delete" (click)="handleDeleteStore(store.id)" title="Xóa">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="pagination">
    <button (click)="goToPreviousPage()" [disabled]="!hasPreviousPage">Trang trước</button>
    <span>Trang {{ currentPage + 1 }} / {{ pagesCount }}</span>
    <button (click)="goToNextPage()" [disabled]="!hasNextPage">Trang sau</button>
  </div>
</div>

<!-- Modal chỉnh sửa -->
<div class="modal-overlay" *ngIf="isEditModalOpen" (click)="handleBackdropClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Chỉnh sửa thông tin cửa hàng</h2>
    <form (ngSubmit)="saveEdit()" #editForm="ngForm">
      <div class="form-row">
        <div class="form-group half">
          <label>Tên cửa hàng *</label>
          <input type="text" [(ngModel)]="selectedStore.storeName" name="storeName" required #storeNameModel="ngModel" />
          <div class="error-message" *ngIf="storeNameModel.invalid && storeNameModel.touched">
            Tên cửa hàng không được để trống.
          </div>
        </div>

        <div class="form-group half">
          <label>Số điện thoại *</label>
          <input type="text" [(ngModel)]="selectedStore.phone" name="phone" required #phoneModel="ngModel" />
          <div class="error-message" *ngIf="phoneModel.invalid && phoneModel.touched">
            Số điện thoại không được để trống.
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group half">
          <label>Email</label>
          <input type="email" [(ngModel)]="selectedStore.email" name="email" #emailModel="ngModel" />
        </div>

        <div class="form-group half">
          <label>Website</label>
          <input type="text" [(ngModel)]="selectedStore.website" name="website" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full">
          <label>Địa chỉ *</label>
          <input type="text" [(ngModel)]="selectedStore.address" name="address" required #addressModel="ngModel" />
          <div class="error-message" *ngIf="addressModel.invalid && addressModel.touched">
            Địa chỉ không được để trống.
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full">
          <label>Mô tả</label>
          <textarea [(ngModel)]="selectedStore.description" name="description" rows="4"></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" (click)="closeEditModal()">Hủy bỏ</button>
        <button type="submit" [disabled]="editForm.invalid">Hoàn tất</button>
      </div>
    </form>
  </div>
</div>

<app-toast-notification *ngIf="showToast" [message]="toastMessage" [type]="toastType" (closed)="onToastClosed()">
</app-toast-notification>