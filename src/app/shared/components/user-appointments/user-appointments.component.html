<app-header></app-header>
<div class="user-appointments-container">
  <div class="header-section">
    <h1>ğŸ“… Lá»‹ch háº¹n xem xe cá»§a tÃ´i</h1>
    <p>Quáº£n lÃ½ cÃ¡c lá»‹ch háº¹n xem xe cá»§a báº¡n</p>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <button class="tab-btn" [class.active]="selectedTab === 'all'" (click)="selectTab('all')">
      ğŸ“‹ Táº¥t cáº£ ({{ appointments.length }})
    </button>
    <button class="tab-btn" [class.active]="selectedTab === 'upcoming'" (click)="selectTab('upcoming')">
      ğŸ”” Sáº¯p tá»›i
    </button>
    <button class="tab-btn" [class.active]="selectedTab === 'past'" (click)="selectTab('past')">
      ğŸ“œ ÄÃ£ qua
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Äang táº£i...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredAppointments.length === 0" class="empty-state">
    <div class="empty-icon">ğŸ“­</div>
    <h3>ChÆ°a cÃ³ lá»‹ch háº¹n nÃ o</h3>
    <p *ngIf="selectedTab === 'all'">Báº¡n chÆ°a Ä‘áº·t lá»‹ch xem xe nÃ o. HÃ£y tÃ¬m xe Æ°ng Ã½ vÃ  Ä‘áº·t lá»‹ch ngay!</p>
    <p *ngIf="selectedTab === 'upcoming'">Báº¡n khÃ´ng cÃ³ lá»‹ch háº¹n sáº¯p tá»›i.</p>
    <p *ngIf="selectedTab === 'past'">Báº¡n khÃ´ng cÃ³ lá»‹ch háº¹n nÃ o trong quÃ¡ khá»©.</p>
    <button class="btn-primary" routerLink="/car-old">ğŸš— TÃ¬m xe ngay</button>
  </div>

  <!-- Appointments List -->
  <div class="appointments-list" *ngIf="!isLoading && filteredAppointments.length > 0">
    <div *ngFor="let appointment of filteredAppointments" class="appointment-card"
      [class]="getStatusInfo(appointment.status).class">

      <!-- Countdown badge -->
      <div class="countdown-badge"
        *ngIf="getDaysUntilAppointment(appointment.appointmentDate) >= 0 && appointment.status !== 3 && appointment.status !== 2">
        <span *ngIf="getDaysUntilAppointment(appointment.appointmentDate) === 0">ğŸ”¥ HÃ´m nay</span>
        <span *ngIf="getDaysUntilAppointment(appointment.appointmentDate) === 1">â° NgÃ y mai</span>
        <span *ngIf="getDaysUntilAppointment(appointment.appointmentDate) > 1">
          CÃ²n {{ getDaysUntilAppointment(appointment.appointmentDate) }} ngÃ y
        </span>
      </div>

      <div class="card-content" (click)="openDetailModal(appointment)">
        <div class="car-section">
          <img [src]="appointment.carImageUrl || 'https://via.placeholder.com/120x80?text=Car'"
            [alt]="appointment.carModel" class="car-image">
          <div class="car-info">
            <h3>{{ appointment.carModel }} {{ appointment.carYear }}</h3>
            <p class="car-price">{{ appointment.carPrice | number }} Ä‘</p>
            <p class="dealer-name">ğŸª {{ appointment.dealerName }}</p>
          </div>
        </div>

        <div class="appointment-info">
          <div class="info-row">
            <span class="icon">ğŸ“…</span>
            <span class="text">{{ formatDate(appointment.appointmentDate) }}</span>
          </div>
          <div class="info-row">
            <span class="icon">ğŸ•</span>
            <span class="text">{{ formatTime(appointment.appointmentTime) }} ({{ appointment.durationMinutes }}
              phÃºt)</span>
          </div>
          <div class="info-row">
            <span class="icon">ğŸ“</span>
            <span class="text">{{ appointment.dealerAddress }}</span>
          </div>
          <div class="info-row">
            <span class="icon">ğŸ“</span>
            <span class="text">{{ appointment.dealerPhone }}</span>
          </div>
        </div>

        <div class="status-section">
          <span class="status-badge" [class]="getStatusInfo(appointment.status).class">
            {{ getStatusInfo(appointment.status).icon }} {{ getStatusInfo(appointment.status).text }}
          </span>
        </div>
      </div>

      <div class="card-actions">
        <button class="btn-detail" (click)="openDetailModal(appointment); $event.stopPropagation()">
          <i class="fas fa-info-circle"></i> Chi tiáº¿t
        </button>
        <button class="btn-view-car" (click)="goToCarDetail(appointment.carId); $event.stopPropagation()">
          <i class="fas fa-car"></i> Xem xe
        </button>
        <button *ngIf="canCancel(appointment)" class="btn-cancel-appointment"
          (click)="openCancelModal(appointment); $event.stopPropagation()">
          <i class="fas fa-times"></i> Há»§y lá»‹ch
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" *ngIf="isDetailModalOpen" (click)="closeDetailModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ğŸ“‹ Chi tiáº¿t lá»‹ch háº¹n</h2>
      <button class="close-btn" (click)="closeDetailModal()">&times;</button>
    </div>

    <div class="modal-body" *ngIf="selectedAppointment">
      <div class="detail-section">
        <h3>ğŸš— ThÃ´ng tin xe</h3>
        <div class="car-detail">
          <img [src]="selectedAppointment.carImageUrl || 'https://via.placeholder.com/200x130?text=Car'" alt="Car">
          <div>
            <p><strong>Máº«u xe:</strong> {{ selectedAppointment.carModel }} {{ selectedAppointment.carYear }}</p>
            <p><strong>GiÃ¡:</strong> {{ selectedAppointment.carPrice | number }} Ä‘</p>
            <button class="btn-link" (click)="goToCarDetail(selectedAppointment.carId)">
              Xem chi tiáº¿t xe â†’
            </button>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>ğŸª ThÃ´ng tin cá»­a hÃ ng</h3>
        <p><strong>TÃªn:</strong> {{ selectedAppointment.dealerName }}</p>
        <p><strong>Äá»‹a chá»‰:</strong> {{ selectedAppointment.dealerAddress }}</p>
        <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> {{ selectedAppointment.dealerPhone }}</p>
      </div>

      <div class="detail-section">
        <h3>ğŸ“… ThÃ´ng tin lá»‹ch háº¹n</h3>
        <!-- Trong modal chi tiáº¿t -->
        <p><strong>NgÃ y:</strong> {{ formatDate(selectedAppointment?.appointmentDate ?? []) }}</p>
        <p><strong>Giá»:</strong> {{ formatTime(selectedAppointment?.appointmentTime ?? []) }}</p>
        <p><strong>Thá»i lÆ°á»£ng:</strong> {{ selectedAppointment?.durationMinutes }} phÃºt</p>
        <p><strong>Tráº¡ng thÃ¡i:</strong>
          <span class="status-badge" [class]="getStatusInfo(selectedAppointment?.status ?? 0).class">
            {{ getStatusInfo(selectedAppointment?.status ?? 0).icon }} {{ getStatusInfo(selectedAppointment?.status ??
            0).text }}
          </span>
        </p>
      </div>

      <div class="detail-section" *ngIf="selectedAppointment.notes">
        <h3>ğŸ“ Ghi chÃº cá»§a báº¡n</h3>
        <p>{{ selectedAppointment?.notes }}</p>
      </div>

      <div class="detail-section">
        <h3>ğŸ‘¤ ThÃ´ng tin liÃªn há»‡</h3>
        <p><strong>Há» tÃªn:</strong> {{ selectedAppointment?.customerName }}</p>
        <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> {{ selectedAppointment?.customerPhone }}</p>
        <p><strong>Email:</strong> {{ selectedAppointment?.customerEmail }}</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-close" (click)="closeDetailModal()">ÄÃ³ng</button>
      <button *ngIf="selectedAppointment && canCancel(selectedAppointment)" class="btn-cancel-modal"
        (click)="selectedAppointment && openCancelModal(selectedAppointment)">
        Há»§y lá»‹ch háº¹n
      </button>
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div class="modal-overlay" *ngIf="isCancelModalOpen" (click)="closeCancelModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>âŒ Há»§y lá»‹ch háº¹n</h2>
      <button class="close-btn" (click)="closeCancelModal()">&times;</button>
    </div>

    <div class="modal-body">
      <p>Báº¡n cÃ³ cháº¯c muá»‘n há»§y lá»‹ch háº¹n xem xe <strong>{{ selectedAppointment?.carModel }}</strong> vÃ o ngÃ y <strong>{{
          selectedAppointment && formatDate(selectedAppointment.appointmentDate) }}</strong>?</p>
      <p class="warning-text">âš ï¸ HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.</p>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel-action" (click)="closeCancelModal()">KhÃ´ng, giá»¯ lá»‹ch</button>
      <button class="btn-confirm-cancel" (click)="cancelAppointment()">CÃ³, há»§y lá»‹ch</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast-notification" *ngIf="showToast" [class]="toastType">
  <span>{{ toastMessage }}</span>
  <button class="toast-close" (click)="hideToast()">&times;</button>
</div>
<app-footer></app-footer>